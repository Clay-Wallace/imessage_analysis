import pandas as pd

def get_earliest_and_latest(messages, sender=None):
    # Generated by ChatGPT
    messages = pd.DataFrame(messages)
    if sender is not None:
        mask = messages["convo_id"].str.lower().str.strip() == sender.lower().strip()
        filtered = messages[mask]
    else:
        filtered = messages

    earliest = filtered["date_obj"].min()
    latest   = filtered["date_obj"].max()
    return earliest, latest

def stat_overview(messages):
    """Generates an overview of general statistics from iMessage data."""
    print("Calculating statistical overview...")

    df = pd.DataFrame(messages)

    earliest, latest = get_earliest_and_latest(df)

    total = len(df)
    mesg_sent = (df["is_from_me"] == 1).sum()
    mesg_received = total - mesg_sent
    percent_sent = (mesg_sent / total) * 100 if total > 0 else 0
    percent_received = 100 - percent_sent

    
    senders = set(df[df["is_from_me"] == 0]["phone_number"].dropna().unique())
    recipients = set(df[df["is_from_me"] == 1]["phone_number"].dropna().unique())
    group_chats = set(df[df["cache_roomname"].notna()]["cache_roomname"].unique())
    non_gc_convos = set(df[df["cache_roomname"].isna()]["phone_number"].dropna().unique())
   
    unique_convos = len(group_chats) + len(non_gc_convos)
    percent_gc = (len(group_chats) / unique_convos) * 100 if unique_convos > 0 else 0

    return [earliest, 
            latest, 
            total, 
            mesg_sent, 
            percent_sent, 
            recipients,
            mesg_received, 
            percent_received, 
            senders,
            unique_convos,
            group_chats,
            percent_gc
    ]   

def get_avg_message_length(messages, convo=None):
    df = pd.DataFrame(messages)
    if convo is not None:
        mask = df["convo_id"].str.strip().str.lower() == convo.strip().lower()
        filtered = df[mask]
    else:
        filtered = df

    sent_messages = df[df["is_from_me"] == 1].copy()
    if sent_messages.empty:
        return 0.0
    
    word_counts = sent_messages["body"].astype(str).str.split().str.len()
    average_length = round(word_counts.mean(), 2)
    

    return average_length

def get_msg_times(messages, is_from_me):

    df = pd.DataFrame(messages)
    focus_messages = df[df["is_from_me"] == int(is_from_me)].copy()

    if focus_messages.empty:
        return "N/A", 0

    hours = focus_messages["date_obj"].dt.hour

    periods = [0, 5, 9, 12, 17, 20, 24]
    labels = ["Early Morning (12 AM - 4:59 AM)", "Morning (5 AM - 8:59 AM)", "Prenoon (9 AM - 11:59 AM)", "Afternoon (12 PM - 4:59 PM)", "Evening (5 PM - 7:59 PM)", "Night (8 PM - 11:59 PM)"]

    focus_messages["period"] = pd.cut(hours, bins = periods, labels = labels, right = False, ordered = False)

    period_counts = focus_messages["period"].value_counts()

    top_period = period_counts.idxmax()
    top_count = period_counts.max()

    total_messages = len(focus_messages)
    percent_top = round((top_count / total_messages) * 100, 2)

    return top_period, percent_top

def get_attachment_percentage(messages):

    df = pd.DataFrame(messages)
    attachments = df[df["cache_has_attachments"] == 1].copy()

    percent_attachments = round(len(attachments)/len(df), 2)

    return percent_attachments

def get_avg_user_response_time(messages):
    
    df = pd.DataFrame(messages)
    df_1 = df[df["cache_roomname"].isna()].copy()

    df_1['date_obj'] = pd.to_datetime(df_1['date_obj'])

    is_single_convo = (
            (df['phone_number'].nunique() <= 1) and 
            (df['cache_roomname'].isna().all())
        )
        
    if is_single_convo:
        df = df.sort_values("date_obj")
        prev_sender = df['is_from_me'].shift(1)
        prev_date = df['date_obj'].shift(1)
        is_reply = (df['is_from_me'] == 1) & (prev_sender == 0)
        reply_times = df.loc[is_reply, 'date_obj'] - prev_date.loc[is_reply]
    else:
        results = []
        for phone_number, group in df_1.groupby("phone_number"):
            group = group.sort_values("date_obj")
            prev_sender = group['is_from_me'].shift(1)
            prev_date = group['date_obj'].shift(1)
            is_reply = (group['is_from_me'] == 1) & (prev_sender == 0)
            reply_times = group.loc[is_reply, 'date_obj'] - prev_date.loc[is_reply]

            if not reply_times.empty:
                # avg_time = reply_times.mean()
                # results.append({
                #     'phone_number': phone_number, 
                #     'avg_reply_time': avg_time,
                #     'reply_count': len(reply_times) 
                # })
                results.append(reply_times)
        if not results:
            return "No replies found"
        reply_times = pd.concat(results)
    
    if reply_times.empty:
        return "No replies found"

    average_response_time = reply_times.median()

    components = average_response_time.components

    days = components.days
    hours = components.hours
    minutes = components.minutes
    seconds = components.seconds

    response_time = []
    if days > 0:
        response_time.append(f"{days} day")
    if hours > 0:
        response_time.append(f"{hours} hr")
    if minutes > 0:
        response_time.append(f"{minutes} min")
    if seconds > 0:
        response_time.append(f"{seconds} sec")
    if not response_time:
        response_time.append("<1 second")

    response_time_str = " ".join(response_time)

    return response_time_str

def habit_overivew(messages):
    """Generates an overview of user messaging habits"""

    avg_mesg_length = get_avg_message_length(messages)

    sent_msg_period, sent_period_percent = get_msg_times(messages, 1)

    rec_msg_period, rec_period_percent = get_msg_times(messages, 0)

    percent_attachments = get_attachment_percentage(messages)

    average_response_time = get_avg_user_response_time(messages)

    return [
        avg_mesg_length,
        sent_msg_period,
        sent_period_percent,
        rec_msg_period,
        rec_period_percent,
        percent_attachments,
        average_response_time
    ]

def social_network(messages):
    top_contacts = []
    df = pd.DataFrame(messages)
    top_convos = df["convo_id"].value_counts().head(10)


    for name, total_count in top_convos.items():
        convo_mask = df["convo_id"] == name
        convo_df = df[convo_mask]
        
        is_group_chat = "(Group chat)" if convo_df["cache_roomname"].notna().any() else ""
        
        earliest_msg = convo_df["date_obj"].min()
        latest_msg = convo_df["date_obj"].max()

        mesg_sent = convo_df["is_from_me"].sum()
        mesg_received = total_count - mesg_sent
        
        percent_sent = (mesg_sent / total_count) * 100 if total_count > 0 else 0
        percent_received = 100 - percent_sent

        habits = habit_overivew(convo_df)
        
        new_row = {
            "name": name,
            "total_count": total_count, 
            "is_group_chat": is_group_chat, 
            "earliest_msg": earliest_msg, 
            "latest_msg": latest_msg, 
            "mesg_sent": mesg_sent, 
            "mesg_received": mesg_received, 
            "percent_sent": percent_sent, 
            "percent_received": percent_received,
            "avg_mesg_length": habits[0],
            "sent_msg_period": habits[1],
            "sent_period_percent": habits[2],
            "rec_msg_period": habits[3],
            "rec_period_percent": habits[4],
            "percent_attachments": habits[5],
            "average_response_time": habits[6]
        }

        top_contacts.append(new_row)
    
    return top_contacts
        











        



        












    





